<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Integro - AI Agent Chat Interface</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .chat-message {
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            padding: 8px 12px;
            background: #f3f4f6;
            border-radius: 18px;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background: #9ca3af;
            border-radius: 50%;
            display: inline-block;
            margin: 0 2px;
            animation: typing 1.4s infinite;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
            }
            30% {
                transform: translateY(-10px);
            }
        }
        .markdown-content h1, .markdown-content h2, .markdown-content h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        .markdown-content h1 { font-size: 1.5rem; }
        .markdown-content h2 { font-size: 1.25rem; }
        .markdown-content h3 { font-size: 1.1rem; }
        .markdown-content p { margin-bottom: 0.5rem; }
        .markdown-content ul, .markdown-content ol {
            margin-left: 1.5rem;
            margin-bottom: 0.5rem;
        }
        .markdown-content code {
            background: #f3f4f6;
            padding: 0.125rem 0.25rem;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .markdown-content pre {
            background: #1f2937;
            color: #f3f4f6;
            padding: 1rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }
        .markdown-content pre code {
            background: transparent;
            padding: 0;
            color: inherit;
        }
        .sidebar-transition {
            transition: transform 0.3s ease-in-out;
        }
        @media (max-width: 768px) {
            .sidebar-closed {
                transform: translateX(-100%);
            }
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        function App() {
            const [agents, setAgents] = useState([]);
            const [knowledgeBases, setKnowledgeBases] = useState([]);
            const [selectedAgent, setSelectedAgent] = useState(null);
            const [selectedKB, setSelectedKB] = useState(null);
            const [messages, setMessages] = useState([]);
            const [inputMessage, setInputMessage] = useState('');
            const [isConnected, setIsConnected] = useState(false);
            const [isTyping, setIsTyping] = useState(false);
            const [sidebarOpen, setSidebarOpen] = useState(true);
            const [currentSessionId, setCurrentSessionId] = useState(null);
            const messagesEndRef = useRef(null);
            const wsRef = useRef(null);
            const clientIdRef = useRef(`client-${Date.now()}`);
            
            // Scroll to bottom of messages
            const scrollToBottom = () => {
                messagesEndRef.current?.scrollIntoView({ behavior: "smooth" });
            };
            
            useEffect(() => {
                scrollToBottom();
            }, [messages, isTyping]);
            
            // Load agents and knowledge bases
            useEffect(() => {
                fetchAgents();
                fetchKnowledgeBases();
                connectWebSocket();
                
                return () => {
                    if (wsRef.current) {
                        wsRef.current.close();
                    }
                };
            }, []);
            
            const fetchAgents = async () => {
                try {
                    const response = await fetch('/api/agents');
                    const data = await response.json();
                    setAgents(data);
                } catch (error) {
                    console.error('Error fetching agents:', error);
                }
            };
            
            const fetchKnowledgeBases = async () => {
                try {
                    const response = await fetch('/api/knowledge-bases');
                    const data = await response.json();
                    setKnowledgeBases(data);
                } catch (error) {
                    console.error('Error fetching knowledge bases:', error);
                }
            };
            
            const connectWebSocket = () => {
                const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${protocol}//${window.location.host}/ws/${clientIdRef.current}`;
                
                const ws = new WebSocket(wsUrl);
                
                ws.onopen = () => {
                    console.log('WebSocket connected');
                    setIsConnected(true);
                    addSystemMessage('Connected to server');
                };
                
                ws.onclose = () => {
                    console.log('WebSocket disconnected');
                    setIsConnected(false);
                    addSystemMessage('Disconnected from server');
                    // Attempt to reconnect after 3 seconds
                    setTimeout(connectWebSocket, 3000);
                };
                
                ws.onerror = (error) => {
                    console.error('WebSocket error:', error);
                    addSystemMessage('Connection error');
                };
                
                ws.onmessage = (event) => {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                };
                
                wsRef.current = ws;
            };
            
            const handleWebSocketMessage = (data) => {
                switch (data.type) {
                    case 'agent_loaded':
                        addSystemMessage(`Agent loaded successfully`);
                        break;
                    case 'chat_response':
                        addAssistantMessage(data.content);
                        setIsTyping(false);
                        break;
                    case 'typing':
                        setIsTyping(data.status);
                        break;
                    case 'error':
                        addSystemMessage(`Error: ${data.message}`);
                        setIsTyping(false);
                        break;
                    case 'session_created':
                        setCurrentSessionId(data.session_id);
                        addSystemMessage('New session started');
                        break;
                }
            };
            
            const sendWebSocketMessage = (message) => {
                if (wsRef.current && wsRef.current.readyState === WebSocket.OPEN) {
                    wsRef.current.send(JSON.stringify(message));
                }
            };
            
            const loadAgent = () => {
                if (!selectedAgent) {
                    alert('Please select an agent');
                    return;
                }
                
                sendWebSocketMessage({
                    type: 'load_agent',
                    agent_id: selectedAgent,
                    kb_id: selectedKB
                });
            };
            
            const sendMessage = () => {
                if (!inputMessage.trim()) return;
                
                if (!selectedAgent) {
                    alert('Please select and load an agent first');
                    return;
                }
                
                addUserMessage(inputMessage);
                sendWebSocketMessage({
                    type: 'chat_message',
                    message: inputMessage
                });
                setInputMessage('');
            };
            
            const newSession = () => {
                setMessages([]);
                sendWebSocketMessage({ type: 'new_session' });
            };
            
            const clearChat = () => {
                setMessages([]);
                addSystemMessage('Chat cleared');
            };
            
            const addSystemMessage = (text) => {
                setMessages(prev => [...prev, {
                    type: 'system',
                    content: text,
                    timestamp: new Date()
                }]);
            };
            
            const addUserMessage = (text) => {
                setMessages(prev => [...prev, {
                    type: 'user',
                    content: text,
                    timestamp: new Date()
                }]);
            };
            
            const addAssistantMessage = (text) => {
                setMessages(prev => [...prev, {
                    type: 'assistant',
                    content: text,
                    timestamp: new Date()
                }]);
            };
            
            const renderMessage = (message) => {
                const baseClass = "chat-message mb-4 flex";
                
                if (message.type === 'system') {
                    return (
                        <div className={`${baseClass} justify-center`}>
                            <div className="bg-yellow-100 text-yellow-800 px-4 py-2 rounded-lg text-sm">
                                <i className="fas fa-info-circle mr-2"></i>
                                {message.content}
                            </div>
                        </div>
                    );
                }
                
                if (message.type === 'user') {
                    return (
                        <div className={`${baseClass} justify-end`}>
                            <div className="max-w-3xl">
                                <div className="bg-blue-600 text-white px-4 py-3 rounded-lg">
                                    {message.content}
                                </div>
                                <div className="text-xs text-gray-500 mt-1 text-right">
                                    {message.timestamp.toLocaleTimeString()}
                                </div>
                            </div>
                        </div>
                    );
                }
                
                if (message.type === 'assistant') {
                    return (
                        <div className={`${baseClass} justify-start`}>
                            <div className="max-w-3xl">
                                <div className="bg-white border border-gray-200 px-4 py-3 rounded-lg shadow-sm">
                                    <div 
                                        className="markdown-content"
                                        dangerouslySetInnerHTML={{ 
                                            __html: marked.parse(message.content) 
                                        }}
                                    />
                                </div>
                                <div className="text-xs text-gray-500 mt-1">
                                    {message.timestamp.toLocaleTimeString()}
                                </div>
                            </div>
                        </div>
                    );
                }
            };
            
            return (
                <div className="h-screen flex overflow-hidden">
                    {/* Sidebar */}
                    <div className={`${sidebarOpen ? 'w-80' : 'w-0'} sidebar-transition ${!sidebarOpen && 'sidebar-closed'} bg-white border-r border-gray-200 flex flex-col md:relative absolute z-20 h-full`}>
                        <div className="p-4 border-b border-gray-200">
                            <div className="flex items-center justify-between mb-4">
                                <h2 className="text-xl font-bold text-gray-800">Integro Chat</h2>
                                <button
                                    onClick={() => setSidebarOpen(false)}
                                    className="md:hidden text-gray-500 hover:text-gray-700"
                                >
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <div className="flex items-center space-x-2 text-sm">
                                <div className={`w-2 h-2 rounded-full ${isConnected ? 'bg-green-500' : 'bg-red-500'}`}></div>
                                <span className="text-gray-600">
                                    {isConnected ? 'Connected' : 'Disconnected'}
                                </span>
                            </div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4">
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Select Agent
                                </label>
                                <select
                                    value={selectedAgent || ''}
                                    onChange={(e) => setSelectedAgent(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">Choose an agent...</option>
                                    {agents.map(agent => (
                                        <option key={agent.id} value={agent.id}>
                                            {agent.name}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            
                            <div className="mb-6">
                                <label className="block text-sm font-medium text-gray-700 mb-2">
                                    Knowledge Base (Optional)
                                </label>
                                <select
                                    value={selectedKB || ''}
                                    onChange={(e) => setSelectedKB(e.target.value)}
                                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                >
                                    <option value="">None</option>
                                    {knowledgeBases.map(kb => (
                                        <option key={kb.id} value={kb.id}>
                                            {kb.name}
                                        </option>
                                    ))}
                                </select>
                            </div>
                            
                            <button
                                onClick={loadAgent}
                                className="w-full bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 transition-colors mb-4"
                            >
                                <i className="fas fa-robot mr-2"></i>
                                Load Agent
                            </button>
                            
                            <div className="space-y-2">
                                <button
                                    onClick={newSession}
                                    className="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors"
                                >
                                    <i className="fas fa-plus mr-2"></i>
                                    New Session
                                </button>
                                
                                <button
                                    onClick={clearChat}
                                    className="w-full bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-colors"
                                >
                                    <i className="fas fa-broom mr-2"></i>
                                    Clear Chat
                                </button>
                            </div>
                            
                            {selectedAgent && (
                                <div className="mt-6 p-4 bg-gray-50 rounded-lg">
                                    <h3 className="font-medium text-gray-700 mb-2">Current Agent</h3>
                                    <p className="text-sm text-gray-600">{selectedAgent}</p>
                                    {selectedKB && (
                                        <>
                                            <h3 className="font-medium text-gray-700 mb-2 mt-3">Knowledge Base</h3>
                                            <p className="text-sm text-gray-600">{selectedKB}</p>
                                        </>
                                    )}
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Main Chat Area */}
                    <div className="flex-1 flex flex-col bg-gray-50">
                        {/* Header */}
                        <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
                            <button
                                onClick={() => setSidebarOpen(!sidebarOpen)}
                                className="text-gray-500 hover:text-gray-700"
                            >
                                <i className="fas fa-bars"></i>
                            </button>
                            
                            <h1 className="text-lg font-semibold text-gray-800">
                                {selectedAgent ? `Chatting with ${agents.find(a => a.id === selectedAgent)?.name || 'Agent'}` : 'Select an Agent'}
                            </h1>
                            
                            <div className="w-8"></div>
                        </div>
                        
                        {/* Messages Area */}
                        <div className="flex-1 overflow-y-auto px-4 py-6">
                            <div className="max-w-4xl mx-auto">
                                {messages.length === 0 && (
                                    <div className="text-center text-gray-500 mt-20">
                                        <i className="fas fa-comments text-6xl mb-4 text-gray-300"></i>
                                        <p className="text-lg">No messages yet</p>
                                        <p className="text-sm mt-2">Select an agent and start chatting!</p>
                                    </div>
                                )}
                                
                                {messages.map((message, index) => (
                                    <div key={index}>
                                        {renderMessage(message)}
                                    </div>
                                ))}
                                
                                {isTyping && (
                                    <div className="chat-message mb-4 flex justify-start">
                                        <div className="typing-indicator">
                                            <span></span>
                                            <span></span>
                                            <span></span>
                                        </div>
                                    </div>
                                )}
                                
                                <div ref={messagesEndRef} />
                            </div>
                        </div>
                        
                        {/* Input Area */}
                        <div className="bg-white border-t border-gray-200 px-4 py-4">
                            <div className="max-w-4xl mx-auto">
                                <div className="flex space-x-3">
                                    <input
                                        type="text"
                                        value={inputMessage}
                                        onChange={(e) => setInputMessage(e.target.value)}
                                        onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                                        placeholder="Type your message..."
                                        className="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                                        disabled={!isConnected || !selectedAgent}
                                    />
                                    <button
                                        onClick={sendMessage}
                                        disabled={!isConnected || !selectedAgent || !inputMessage.trim()}
                                        className="bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed"
                                    >
                                        <i className="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }
        
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>